subprojects {
    afterEvaluate {
        ((ProcessResources) jsProcessResources).filter(org.apache.tools.ant.filters.ReplaceTokens, tokens: [VERSION: version, KOTLIN_VERSION: korlibs.KORLIBS_KOTLIN_VERSION], beginToken: "%%%", endToken: "!!!")
    }
    task npmExtract(type: Copy) {
        afterEvaluate {
            dependsOn(jsJar)
            from zipTree(jsJar.outputs.files.toList().first())
            //from(new File(project.projectDir, "src/jsMain/npm/package.json")) { filter(org.apache.tools.ant.filters.ReplaceTokens, tokens: [VERSION: version, KOTLIN_VERSION: "1.3.50"], beginToken: "%%%", endToken: "!!!") }
            from new File(rootDir, "README.md")
            from new File(rootDir, "npm/package.json")
            into new File(buildDir, "npmPackage")
        }
    }
    task npmPublish(type: Exec, dependsOn: [npmExtract]) {
        workingDir "${buildDir}/npmPackage"
        commandLine 'npm', 'publish', '--access', 'public'
    }
}

